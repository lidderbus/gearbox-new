<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èˆ¹ç”¨é½¿è½®ç®±æ•°æ®æ›´æ–°å·¥å…·</title>
  <style>
    :root {
      --primary-color: #2c6ea5;
      --primary-hover: #1c5a8f;
      --secondary-color: #607d8b;
      --success-color: #4caf50;
      --warning-color: #ff9800;
      --danger-color: #f44336;
      --light-gray: #f5f5f5;
      --border-color: #ddd;
      --text-color: #333;
      --radius: 4px;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Microsoft YaHei', 'PingFang SC', -apple-system, BlinkMacSystemFont, sans-serif;
      line-height: 1.6;
      color: var(--text-color);
      background-color: #f9f9f9;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      background-color: var(--primary-color);
      color: white;
      padding: 20px 0;
      margin-bottom: 30px;
      text-align: center;
    }
    
    h1, h2, h3 {
      font-weight: 500;
    }
    
    header h1 {
      margin-bottom: 5px;
    }
    
    header p {
      opacity: 0.8;
      max-width: 800px;
      margin: 0 auto;
    }
    
    .card {
      background-color: white;
      border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 25px;
      margin-bottom: 25px;
    }
    
    .card-title {
      font-size: 1.4rem;
      margin-bottom: 20px;
      color: var(--primary-color);
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
    }
    
    .card-title .icon {
      margin-right: 10px;
      font-size: 1.2em;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group:last-child {
      margin-bottom: 0;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .file-input-group {
      display: flex;
    }
    
    .file-input-group input[type="text"] {
      flex: 1;
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
      border-right: none;
    }
    
    .file-input-group .btn-browse {
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
    }
    
    input[type="text"],
    input[type="file"],
    textarea,
    select {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      background-color: white;
      font-family: inherit;
      font-size: 1rem;
    }
    
    input[type="file"] {
      padding: 8px;
    }
    
    textarea {
      min-height: 200px;
      resize: vertical;
      font-family: monospace;
      font-size: 0.9rem;
    }
    
    .textarea-container {
      position: relative;
    }
    
    .textarea-actions {
      position: absolute;
      top: 5px;
      right: 5px;
      display: flex;
      gap: 5px;
    }
    
    .textarea-actions button {
      padding: 5px;
      background-color: rgba(255, 255, 255, 0.8);
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      cursor: pointer;
    }
    
    .textarea-actions button:hover {
      background-color: var(--light-gray);
    }
    
    .btn {
      display: inline-block;
      padding: 10px 20px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      text-align: center;
      transition: background-color 0.2s, transform 0.1s;
    }
    
    .btn:hover {
      background-color: var(--primary-hover);
    }
    
    .btn:active {
      transform: translateY(1px);
    }
    
    .btn-secondary {
      background-color: var(--secondary-color);
    }
    
    .btn-success {
      background-color: var(--success-color);
    }
    
    .btn-warning {
      background-color: var(--warning-color);
    }
    
    .btn-danger {
      background-color: var(--danger-color);
    }
    
    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .alert {
      padding: 15px;
      border-radius: var(--radius);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
    }
    
    .alert .icon {
      margin-right: 10px;
      font-size: 1.2em;
    }
    
    .alert-success {
      background-color: rgba(76, 175, 80, 0.1);
      border: 1px solid var(--success-color);
      color: var(--success-color);
    }
    
    .alert-warning {
      background-color: rgba(255, 152, 0, 0.1);
      border: 1px solid var(--warning-color);
      color: var(--warning-color);
    }
    
    .alert-danger {
      background-color: rgba(244, 67, 54, 0.1);
      border: 1px solid var(--danger-color);
      color: var(--danger-color);
    }
    
    .progress {
      height: 10px;
      background-color: var(--light-gray);
      border-radius: var(--radius);
      overflow: hidden;
      margin-bottom: 5px;
    }
    
    .progress-bar {
      height: 100%;
      background-color: var(--primary-color);
      width: 0;
      transition: width 0.3s;
    }
    
    .tabs {
      display: flex;
      list-style: none;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 20px;
    }
    
    .tab-item {
      padding: 10px 20px;
      cursor: pointer;
      border: 1px solid transparent;
      border-bottom: none;
      border-radius: var(--radius) var(--radius) 0 0;
      margin-right: 5px;
      margin-bottom: -1px;
      background-color: var(--light-gray);
      transition: all 0.2s;
    }
    
    .tab-item.active {
      background-color: white;
      border-color: var(--border-color);
      position: relative;
    }
    
    .tab-item.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 1px;
      background-color: white;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .data-summary {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .summary-card {
      background-color: white;
      border-radius: var(--radius);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      padding: 15px;
      border-left: 4px solid var(--primary-color);
    }
    
    .summary-card h4 {
      margin-top: 0;
      margin-bottom: 5px;
      color: var(--primary-color);
    }
    
    .summary-card .count {
      font-size: 24px;
      font-weight: bold;
    }
    
    .summary-card .count-changed {
      color: var(--warning-color);
      font-weight: bold;
    }
    
    .summary-card p {
      margin: 5px 0 0;
      font-size: 0.9rem;
      color: var(--secondary-color);
    }
    
    .table-responsive {
      overflow-x: auto;
      margin-top: 20px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    table th, table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }
    
    table th {
      background-color: var(--light-gray);
      font-weight: 500;
    }
    
    table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    table tr:hover {
      background-color: #f1f1f1;
    }
    
    .changed {
      background-color: rgba(255, 152, 0, 0.1);
    }
    
    .added {
      background-color: rgba(76, 175, 80, 0.1);
    }
    
    .footer {
      text-align: center;
      margin-top: 50px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
      color: var(--secondary-color);
    }
    
    @media (max-width: 768px) {
      .data-summary {
        grid-template-columns: repeat(auto-fill, minmax(100%, 1fr));
      }
      
      .btn-group {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }
    }
    
    /* åŠ è½½åŠ¨ç”» */
    .loader {
      display: none;
      text-align: center;
      padding: 30px 0;
    }
    
    .loader-spinner {
      display: inline-block;
      width: 50px;
      height: 50px;
      border: 5px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>èˆ¹ç”¨é½¿è½®ç®±æ•°æ®æ›´æ–°å·¥å…·</h1>
      <p>å°†é½¿è½®ç®±ä»·æ ¼è¡¨æ•°æ®å¯¼å…¥å¹¶æ›´æ–°åˆ°ç³»ç»Ÿä¸­</p>
    </div>
  </header>
  
  <div class="container">
    <div id="alerts"></div>
    
    <div class="card">
      <h2 class="card-title">
        <span class="icon">ğŸ“</span>æ•°æ®å¯¼å…¥
      </h2>
      
      <ul class="tabs">
        <li class="tab-item active" data-tab="file">æ–‡ä»¶å¯¼å…¥</li>
        <li class="tab-item" data-tab="text">æ–‡æœ¬å¯¼å…¥</li>
      </ul>
      
      <div class="tab-content active" id="file-tab">
        <div class="form-group">
          <label for="target-file">ç›®æ ‡æ–‡ä»¶ (ç°æœ‰ç³»ç»Ÿæ•°æ®):</label>
          <div class="file-input-group">
            <input type="text" id="target-file-path" placeholder="é€‰æ‹©æˆ–è¾“å…¥æ–‡ä»¶è·¯å¾„" readonly>
            <button class="btn btn-browse" id="target-file-browse">æµè§ˆ</button>
            <input type="file" id="target-file" accept=".js" style="display: none;">
          </div>
        </div>
        
        <div class="form-group">
          <label for="source-file">æºæ–‡ä»¶ (æ–°çš„ä»·æ ¼æ•°æ®):</label>
          <div class="file-input-group">
            <input type="text" id="source-file-path" placeholder="é€‰æ‹©æˆ–è¾“å…¥æ–‡ä»¶è·¯å¾„" readonly>
            <button class="btn btn-browse" id="source-file-browse">æµè§ˆ</button>
            <input type="file" id="source-file" accept=".js,.txt" style="display: none;">
          </div>
        </div>
        
        <div class="btn-group">
          <button class="btn" id="import-file-btn">å¯¼å…¥æ•°æ®</button>
          <button class="btn btn-secondary" id="reset-file-btn">é‡ç½®</button>
        </div>
      </div>
      
      <div class="tab-content" id="text-tab">
        <div class="form-group">
          <label for="target-text">ç›®æ ‡æ–‡æœ¬ (ç°æœ‰ç³»ç»Ÿæ•°æ®):</label>
          <div class="textarea-container">
            <textarea id="target-text" placeholder="ç²˜è´´ç°æœ‰çš„ embeddedData.js å†…å®¹"></textarea>
            <div class="textarea-actions">
              <button title="æ¸…ç©º" id="clear-target-text">ğŸ—‘ï¸</button>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="source-text">æºæ–‡æœ¬ (æ–°çš„ä»·æ ¼æ•°æ®):</label>
          <div class="textarea-container">
            <textarea id="source-text" placeholder="ç²˜è´´æ–°çš„ embeddednew.js å†…å®¹æˆ– OCR å¤„ç†åçš„ä»·æ ¼è¡¨"></textarea>
            <div class="textarea-actions">
              <button title="æ¸…ç©º" id="clear-source-text">ğŸ—‘ï¸</button>
            </div>
          </div>
        </div>
        
        <div class="btn-group">
          <button class="btn" id="import-text-btn">å¯¼å…¥æ•°æ®</button>
          <button class="btn btn-secondary" id="reset-text-btn">é‡ç½®</button>
        </div>
      </div>
    </div>
    
    <div class="card" id="result-card" style="display: none;">
      <h2 class="card-title">
        <span class="icon">ğŸ“Š</span>æ•°æ®åˆå¹¶ç»“æœ
      </h2>
      
      <div id="data-summary" class="data-summary">
        <!-- æ•°æ®æ‘˜è¦å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
      </div>
      
      <div class="form-group">
        <label for="merged-code">åˆå¹¶åçš„ä»£ç :</label>
        <div class="textarea-container">
          <textarea id="merged-code" readonly></textarea>
          <div class="textarea-actions">
            <button title="å¤åˆ¶" id="copy-merged-code">ğŸ“‹</button>
            <button title="ä¸‹è½½" id="download-merged-code">ğŸ’¾</button>
          </div>
        </div>
      </div>
      
      <div class="btn-group">
        <button class="btn btn-success" id="apply-btn">åº”ç”¨åˆ°ç³»ç»Ÿ</button>
        <button class="btn btn-secondary" id="back-btn">è¿”å›ç¼–è¾‘</button>
      </div>
    </div>
    
    <div class="loader" id="loader">
      <div class="loader-spinner"></div>
      <p>æ­£åœ¨å¤„ç†æ•°æ®ï¼Œè¯·ç¨å€™...</p>
    </div>
    
    <div class="footer">
      <p>èˆ¹ç”¨é½¿è½®ç®±é€‰å‹ç³»ç»Ÿ &copy; 2025 - æ•°æ®æ›´æ–°å·¥å…·</p>
    </div>
  </div>

  <script>
    // å·¥å…·å‡½æ•° - ä»å­—ç¬¦ä¸²ä¸­æå–JavaScriptå¯¹è±¡
    function extractObjectFromString(content, objectName) {
      try {
        // å¯»æ‰¾å¯¹è±¡å®šä¹‰çš„èµ·å§‹ä½ç½®
        const startPattern = new RegExp(`(export\\s+)?const\\s+${objectName}\\s*=\\s*\\{`);
        const match = content.match(startPattern);
        
        if (!match) {
          console.error(`æ‰¾ä¸åˆ°å¯¹è±¡å®šä¹‰: ${objectName}`);
          return null;
        }
        
        const startPos = match.index;
        let braceCount = 1;
        let endPos = startPos + match[0].length;
        
        // æŸ¥æ‰¾åŒ¹é…çš„å¤§æ‹¬å·ä»¥ç¡®å®šå¯¹è±¡ç»“æŸä½ç½®
        while (braceCount > 0 && endPos < content.length) {
          const char = content[endPos];
          if (char === '{') braceCount++;
          else if (char === '}') braceCount--;
          endPos++;
        }
        
        if (braceCount !== 0) {
          console.error('æ— æ³•æ‰¾åˆ°å¯¹è±¡çš„ç»“æŸä½ç½®');
          return null;
        }
        
        // æå–å®Œæ•´çš„å¯¹è±¡å®šä¹‰
        const objectCode = content.substring(startPos, endPos);
        
        // å‡†å¤‡æ‰§è¡Œä»£ç  - å°†exportæ›¿æ¢ä¸ºletï¼Œä»¥ä¾¿åœ¨å‡½æ•°ä¸­ä½¿ç”¨
        const execCode = objectCode.replace(/export\s+const/, 'const');
        
        // ä½¿ç”¨Functionæ„é€ å™¨æ‰§è¡Œä»£ç å¹¶è¿”å›å¯¹è±¡
        const extractFn = new Function(`
          ${execCode}
          return ${objectName};
        `);
        
        return extractFn();
      } catch (error) {
        console.error('ä»å­—ç¬¦ä¸²ä¸­æå–å¯¹è±¡æ—¶å‡ºé”™:', error);
        return null;
      }
    }

    // å·¥å…·å‡½æ•° - åˆå¹¶é½¿è½®ç®±æ•°æ®
    function mergeGearboxData(targetData, sourceData) {
      if (!targetData) return sourceData;
      if (!sourceData) return targetData;
      
      // åˆ›å»ºç›®æ ‡æ•°æ®çš„æ·±æ‹·è´
      const result = JSON.parse(JSON.stringify(targetData));
      
      // è·Ÿè¸ªæ›´æ”¹
      const changes = {
        updated: [],
        added: [],
        categories: {}
      };
      
      // æ›´æ–°å…ƒæ•°æ®
      if (sourceData._version) result._version = sourceData._version;
      if (sourceData._lastFixed) result._lastFixed = sourceData._lastFixed;
      
      // å¤„ç†æ¯ä¸ªé½¿è½®ç®±ç±»åˆ« (hcGearboxes, gwGearboxes, etc.)
      Object.keys(sourceData).forEach(category => {
        // è·³è¿‡éæ•°ç»„å±æ€§
        if (!Array.isArray(sourceData[category])) {
          if (!['_version', '_lastFixed'].includes(category)) {
            result[category] = sourceData[category];
          }
          return;
        }
        
        // ç¡®ä¿ç›®æ ‡ä¸­æœ‰ç›¸åº”ç±»åˆ«æ•°ç»„
        if (!Array.isArray(result[category])) {
          result[category] = [];
        }
        
        // åˆå§‹åŒ–ç±»åˆ«æ›´æ”¹è®¡æ•°
        changes.categories[category] = {
          total: result[category].length,
          updated: 0,
          added: 0
        };
        
        // ä¸ºç›®æ ‡ç±»åˆ«åˆ›å»ºå‹å·æ˜ å°„ï¼Œä¾¿äºå¿«é€ŸæŸ¥æ‰¾
        const modelMap = new Map(
          result[category].map(item => [item.model, item])
        );
        
        // å¤„ç†æºæ•°æ®ä¸­çš„æ¯ä¸€é¡¹
        sourceData[category].forEach(sourceItem => {
          if (!sourceItem.model) return; // è·³è¿‡æ— æ•ˆé¡¹
          
          const existingItem = modelMap.get(sourceItem.model);
          
          if (existingItem) {
            // æ›´æ–°ç°æœ‰é¡¹
            let isUpdated = false;
            
            Object.keys(sourceItem).forEach(key => {
              // å¯¹äºä»·æ ¼ç›¸å…³å­—æ®µï¼Œä¼˜å…ˆä½¿ç”¨æºæ•°æ®
              if (['basePrice', 'price', 'discountRate', 'factoryPrice', 
                   'packagePrice', 'marketPrice', 'notes'].includes(key)) {
                if (existingItem[key] !== sourceItem[key]) {
                  existingItem[key] = sourceItem[key];
                  isUpdated = true;
                }
              }
              // å¯¹äºå…¶ä»–å…³é”®æŠ€æœ¯å‚æ•°ï¼Œå½“ç°æœ‰æ•°æ®å­—æ®µä¸ºç©ºæˆ–0æ—¶æ›´æ–°
              else if (existingItem[key] === null || existingItem[key] === undefined || 
                      existingItem[key] === 0 || existingItem[key] === '' || 
                      existingItem[key] === '-') {
                existingItem[key] = sourceItem[key];
                isUpdated = true;
              }
            });
            
            if (isUpdated) {
              changes.updated.push({
                category,
                model: sourceItem.model
              });
              changes.categories[category].updated++;
            }
          } else {
            // æ·»åŠ æ–°é¡¹
            result[category].push(JSON.parse(JSON.stringify(sourceItem)));
            modelMap.set(sourceItem.model, result[category][result[category].length - 1]);
            
            changes.added.push({
              category,
              model: sourceItem.model
            });
            changes.categories[category].added++;
          }
        });
        
        // æ›´æ–°æ€»æ•°
        changes.categories[category].total = result[category].length;
      });
      
      return { data: result, changes };
    }

    // å·¥å…·å‡½æ•° - å°†æ•°æ®å¯¹è±¡è½¬æ¢ä¸ºJavaScriptä»£ç å­—ç¬¦ä¸²
    function convertToJsCode(data, includeFunction = true) {
      const now = new Date();
      const dateStr = now.toISOString().split('T')[0];
      
      let code = `// src/data/embeddedData.js
// èˆ¹ç”¨é½¿è½®ç®±å†…ç½®æ•°æ® - è‡ªåŠ¨æ›´æ–°äº ${dateStr}
// æ•°æ®æ¥æºï¼š
// - OCRä»·æ ¼è¡¨åŠå…¶ä»–æ›´æ–°æ¥æº
// - embeddednew.jsä»·æ ¼åŠå‚æ•°æ•°æ®
//
// æ›´æ–°é€»è¾‘ï¼š
// - ä¿ç•™ç°æœ‰æ•°æ®ç»“æ„å’Œéä»·æ ¼å‚æ•°å­—æ®µ
// - ä¸“æ³¨äºæ›´æ–°ä»·æ ¼ç›¸å…³å­—æ®µ(basePrice, price, discountRate, factoryPrice, packagePrice, marketPrice)
// - å½“ç°æœ‰æŠ€æœ¯å‚æ•°å­—æ®µä¸ºç©ºæˆ–0æ—¶ï¼Œä½¿ç”¨æ–°æ•°æ®æ›¿æ¢

/**
 * åµŒå…¥å¼é½¿è½®ç®±æ•°æ®é›†
 * key ä¸ºåˆ†ç±»ï¼Œvalue ä¸ºå¯¹åº”æ•°ç»„
 */
export const embeddedGearboxData = ${JSON.stringify(data, null, 2)};
`;

      if (includeFunction) {
        code += `

/**
 * æ ¹æ®å¤–éƒ¨ä»·æ ¼è¡¨æ›´æ–°é½¿è½®ç®±ä»·æ ¼
 * @param {object} data åµŒå…¥å¼æ•°æ®
 * @param {Array<{model:string,basePrice:number,discountRate:number,discountedPrice:number}>} priceList å¤–éƒ¨ä»·æ ¼åˆ—è¡¨
 * @returns {object} æ›´æ–°åçš„æ•°æ®
 */
export function applyPriceUpdates(data, priceList) {
  const priceMap = new Map();
  priceList.forEach((item) => {
    const key = item.model.trim();
    priceMap.set(key, item);
  });

  const updated = JSON.parse(JSON.stringify(data));
  Object.values(updated).forEach((arr) => {
    if (!Array.isArray(arr)) return;
    arr.forEach((g) => {
      const p = priceMap.get(g.model);
      if (p) {
        g.basePrice = p.basePrice;
        g.price = p.basePrice;
        g.discountRate = p.discountRate;
        g.factoryPrice = p.discountedPrice;
        g.packagePrice = p.discountedPrice;
        g.marketPrice = g.factoryPrice
          ? parseFloat((g.factoryPrice / (1 - 0.12)).toFixed(2))
          : 0;
        g.priceWarning = false;
      }
    });
  });
  return updated;
}`;
      }
      
      return code;
    }
    
    // å·¥å…·å‡½æ•° - è·å–ç±»åˆ«æ˜¾ç¤ºåç§°
    function getCategoryDisplayName(category) {
      const displayNames = {
        'hcGearboxes': 'HCç³»åˆ—é½¿è½®ç®±',
        'gwGearboxes': 'GWç³»åˆ—é½¿è½®ç®±',
        'gcGearboxes': 'GCç³»åˆ—é½¿è½®ç®±',
        'dtGearboxes': 'DTç³»åˆ—é½¿è½®ç®±',
        'hcqGearboxes': 'HCQç³»åˆ—é½¿è½®ç®±',
        'hcmGearboxes': 'HCMç³»åˆ—é½¿è½®ç®±',
        'standbyPumps': 'å¤‡ç”¨æ³µ',
        'flexibleCouplings': 'é«˜å¼¹æ€§è”è½´å™¨',
        'clutches': 'ç¦»åˆå™¨'
      };
      
      return displayNames[category] || category;
    }
    
    // å·¥å…·å‡½æ•° - æ˜¾ç¤ºæç¤ºä¿¡æ¯
    function showAlert(type, message) {
      const alertsContainer = document.getElementById('alerts');
      const alertElement = document.createElement('div');
      alertElement.className = `alert alert-${type}`;
      
      let icon = 'â“';
      if (type === 'success') icon = 'âœ…';
      if (type === 'warning') icon = 'âš ï¸';
      if (type === 'danger') icon = 'âŒ';
      
      alertElement.innerHTML = `
        <span class="icon">${icon}</span>
        <div>${message}</div>
      `;
      
      alertsContainer.appendChild(alertElement);
      
      // è‡ªåŠ¨å…³é—­ï¼ˆæˆåŠŸå’Œè­¦å‘Šæç¤ºï¼‰
      if (type === 'success' || type === 'warning') {
        setTimeout(() => {
          alertElement.remove();
        }, 5000);
      }
    }
    
    // å·¥å…·å‡½æ•° - æ¸…é™¤æ‰€æœ‰æç¤ºä¿¡æ¯
    function clearAlerts() {
      const alertsContainer = document.getElementById('alerts');
      alertsContainer.innerHTML = '';
    }
    
    // å·¥å…·å‡½æ•° - æ˜¾ç¤º/éšè—åŠ è½½åŠ¨ç”»
    function toggleLoader(show) {
      const loader = document.getElementById('loader');
      loader.style.display = show ? 'block' : 'none';
    }
    
    // å·¥å…·å‡½æ•° - ä¸‹è½½æ–‡æœ¬ä¸ºæ–‡ä»¶
    function downloadTextAsFile(text, filename) {
      const blob = new Blob([text], { type: 'text/javascript' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    // å·¥å…·å‡½æ•° - å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showAlert('success', 'å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
      }).catch(err => {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        showAlert('danger', 'å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
      });
    }
    
    // å·¥å…·å‡½æ•° - æ›´æ–°æ•°æ®æ‘˜è¦æ˜¾ç¤º
    function updateDataSummary(changes) {
      const summaryContainer = document.getElementById('data-summary');
      summaryContainer.innerHTML = '';
      
      Object.keys(changes.categories).forEach(category => {
        const data = changes.categories[category];
        const displayName = getCategoryDisplayName(category);
        
        const card = document.createElement('div');
        card.className = 'summary-card';
        
        let hasChanges = data.updated > 0 || data.added > 0;
        
        card.innerHTML = `
          <h4>${displayName}</h4>
          <div class="count ${hasChanges ? 'count-changed' : ''}">
            ${data.total} é¡¹
          </div>
          <p>
            ${data.updated > 0 ? `æ›´æ–°: <strong>${data.updated}</strong>` : ''}
            ${data.updated > 0 && data.added > 0 ? ' | ' : ''}
            ${data.added > 0 ? `æ–°å¢: <strong>${data.added}</strong>` : ''}
            ${data.updated === 0 && data.added === 0 ? 'æ— å˜æ›´' : ''}
          </p>
        `;
        
        summaryContainer.appendChild(card);
      });
    }
    
    // ä¸»å‡½æ•° - å¤„ç†æ•°æ®åˆå¹¶
    function processDataMerge(targetContent, sourceContent) {
      clearAlerts();
      toggleLoader(true);
      
      setTimeout(() => {
        try {
          // å°è¯•ä»ç›®æ ‡å†…å®¹ä¸­æå–æ•°æ®
          const targetData = extractObjectFromString(targetContent, 'embeddedGearboxData');
          
          if (!targetData) {
            showAlert('danger', 'æ— æ³•ä»ç›®æ ‡å†…å®¹ä¸­æå– embeddedGearboxData å¯¹è±¡ã€‚è¯·ç¡®ä¿å†…å®¹æ ¼å¼æ­£ç¡®ã€‚');
            toggleLoader(false);
            return;
          }
          
          // å°è¯•ä»æºå†…å®¹ä¸­æå–æ•°æ®
          const sourceData = extractObjectFromString(sourceContent, 'embeddedGearboxData');
          
          if (!sourceData) {
            showAlert('danger', 'æ— æ³•ä»æºå†…å®¹ä¸­æå– embeddedGearboxData å¯¹è±¡ã€‚è¯·ç¡®ä¿å†…å®¹æ ¼å¼æ­£ç¡®ã€‚');
            toggleLoader(false);
            return;
          }
          
          // åˆå¹¶æ•°æ®
          const { data: mergedData, changes } = mergeGearboxData(targetData, sourceData);
          
          // å°†åˆå¹¶åçš„æ•°æ®è½¬æ¢ä¸ºä»£ç 
          const mergedCode = convertToJsCode(mergedData);
          
          // æ˜¾ç¤ºåˆå¹¶ç»“æœ
          document.getElementById('merged-code').value = mergedCode;
          updateDataSummary(changes);
          
          // éšè—æ•°æ®å¯¼å…¥å¡ç‰‡ï¼Œæ˜¾ç¤ºç»“æœå¡ç‰‡
          document.getElementById('result-card').style.display = 'block';
          
          // æ»šåŠ¨åˆ°ç»“æœå¡ç‰‡
          document.getElementById('result-card').scrollIntoView({ behavior: 'smooth' });
          
          showAlert('success', `æ•°æ®åˆå¹¶æˆåŠŸï¼å…±æ›´æ–°äº† ${changes.updated.length} é¡¹ï¼Œæ–°å¢äº† ${changes.added.length} é¡¹ã€‚`);
        } catch (error) {
          console.error('å¤„ç†æ•°æ®æ—¶å‡ºé”™:', error);
          showAlert('danger', `å¤„ç†æ•°æ®æ—¶å‡ºé”™: ${error.message}`);
        } finally {
          toggleLoader(false);
        }
      }, 500); // æ·»åŠ çŸ­æš‚å»¶è¿Ÿï¼Œä½¿åŠ è½½åŠ¨ç”»å¯è§
    }
    
    // DOMåŠ è½½å®Œæˆåæ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', () => {
      // æ ‡ç­¾åˆ‡æ¢
      document.querySelectorAll('.tab-item').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabId = tab.getAttribute('data-tab');
          
          // æ›´æ–°æ ‡ç­¾çŠ¶æ€
          document.querySelectorAll('.tab-item').forEach(t => {
            t.classList.toggle('active', t === tab);
          });
          
          // æ›´æ–°å†…å®¹çŠ¶æ€
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.toggle('active', content.id === `${tabId}-tab`);
          });
        });
      });
      
      // æ–‡ä»¶æµè§ˆæŒ‰é’®
      document.getElementById('target-file-browse').addEventListener('click', () => {
        document.getElementById('target-file').click();
      });
      
      document.getElementById('source-file-browse').addEventListener('click', () => {
        document.getElementById('source-file').click();
      });
      
      // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
      document.getElementById('target-file').addEventListener('change', event => {
        const file = event.target.files[0];
        if (file) {
          document.getElementById('target-file-path').value = file.name;
        }
      });
      
      document.getElementById('source-file').addEventListener('change', event => {
        const file = event.target.files[0];
        if (file) {
          document.getElementById('source-file-path').value = file.name;
        }
      });
      
      // æ–‡æœ¬æ¸…ç©ºæŒ‰é’®
      document.getElementById('clear-target-text').addEventListener('click', () => {
        document.getElementById('target-text').value = '';
      });
      
      document.getElementById('clear-source-text').addEventListener('click', () => {
        document.getElementById('source-text').value = '';
      });
      
      // æ–‡ä»¶å¯¼å…¥æŒ‰é’®
      document.getElementById('import-file-btn').addEventListener('click', () => {
        const targetFile = document.getElementById('target-file').files[0];
        const sourceFile = document.getElementById('source-file').files[0];
        
        if (!targetFile) {
          showAlert('warning', 'è¯·é€‰æ‹©ç›®æ ‡æ–‡ä»¶');
          return;
        }
        
        if (!sourceFile) {
          showAlert('warning', 'è¯·é€‰æ‹©æºæ–‡ä»¶');
          return;
        }
        
        // è¯»å–æ–‡ä»¶å†…å®¹
        const targetReader = new FileReader();
        const sourceReader = new FileReader();
        
        targetReader.onload = targetEvent => {
          const targetContent = targetEvent.target.result;
          
          sourceReader.onload = sourceEvent => {
            const sourceContent = sourceEvent.target.result;
            
            // å¤„ç†æ•°æ®åˆå¹¶
            processDataMerge(targetContent, sourceContent);
          };
          
          sourceReader.onerror = () => {
            showAlert('danger', 'è¯»å–æºæ–‡ä»¶å¤±è´¥');
          };
          
          sourceReader.readAsText(sourceFile);
        };
        
        targetReader.onerror = () => {
          showAlert('danger', 'è¯»å–ç›®æ ‡æ–‡ä»¶å¤±è´¥');
        };
        
        targetReader.readAsText(targetFile);
      });
      
      // æ–‡ä»¶é‡ç½®æŒ‰é’®
      document.getElementById('reset-file-btn').addEventListener('click', () => {
        document.getElementById('target-file').value = '';
        document.getElementById('source-file').value = '';
        document.getElementById('target-file-path').value = '';
        document.getElementById('source-file-path').value = '';
        clearAlerts();
      });
      
      // æ–‡æœ¬å¯¼å…¥æŒ‰é’®
      document.getElementById('import-text-btn').addEventListener('click', () => {
        const targetContent = document.getElementById('target-text').value;
        const sourceContent = document.getElementById('source-text').value;
        
        if (!targetContent) {
          showAlert('warning', 'è¯·è¾“å…¥ç›®æ ‡æ–‡æœ¬');
          return;
        }
        
        if (!sourceContent) {
          showAlert('warning', 'è¯·è¾“å…¥æºæ–‡æœ¬');
          return;
        }
        
        // å¤„ç†æ•°æ®åˆå¹¶
        processDataMerge(targetContent, sourceContent);
      });
      
      // æ–‡æœ¬é‡ç½®æŒ‰é’®
      document.getElementById('reset-text-btn').addEventListener('click', () => {
        document.getElementById('target-text').value = '';
        document.getElementById('source-text').value = '';
        clearAlerts();
      });
      
      // å¤åˆ¶åˆå¹¶ä»£ç æŒ‰é’®
      document.getElementById('copy-merged-code').addEventListener('click', () => {
        const mergedCode = document.getElementById('merged-code').value;
        
        if (!mergedCode) {
          showAlert('warning', 'æ²¡æœ‰å¯å¤åˆ¶çš„ä»£ç ');
          return;
        }
        
        copyToClipboard(mergedCode);
      });
      
      // ä¸‹è½½åˆå¹¶ä»£ç æŒ‰é’®
      document.getElementById('download-merged-code').addEventListener('click', () => {
        const mergedCode = document.getElementById('merged-code').value;
        
        if (!mergedCode) {
          showAlert('warning', 'æ²¡æœ‰å¯ä¸‹è½½çš„ä»£ç ');
          return;
        }
        
        downloadTextAsFile(mergedCode, 'embeddedData.js');
      });
      
      // åº”ç”¨æŒ‰é’®
      document.getElementById('apply-btn').addEventListener('click', () => {
        showAlert('success', 'æ•°æ®å·²æˆåŠŸæ›´æ–°ï¼è¯·å°†ç”Ÿæˆçš„ä»£ç æ›¿æ¢åˆ°ç³»ç»Ÿä¸­çš„ src/data/embeddedData.js æ–‡ä»¶ã€‚');
      });
      
      // è¿”å›ç¼–è¾‘æŒ‰é’®
      document.getElementById('back-btn').addEventListener('click', () => {
        document.getElementById('result-card').style.display = 'none';
        clearAlerts();
      });
    });
  </script>
</body>
</html>
